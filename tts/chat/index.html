<!DOCTYPE html>
<html lang="zh-CN" class="light-mode">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Free AI 语音聊天助手</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- 添加CryptoJS库，用于讯飞API签名计算 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    :root {
      /* 亮色模式变量 - 未来科技感配色 */
      --bg-color: #f0f4f8;
      --container-bg: rgba(255, 255, 255, 0.85);
      --header-bg: rgba(255, 255, 255, 0.9);
      --header-color: #1a1f36;
      --chat-bg: #f0f4f8;
      --text-color: #1a1f36;
      --text-secondary: #4a5568;
      --text-muted: #718096;
      --border-color: rgba(226, 232, 240, 0.8);
      --user-bubble: linear-gradient(135deg, #3a7bd5, #00d2ff);
      --user-text: #ffffff;
      --bot-bubble: rgba(255, 255, 255, 0.9);
      --input-bg: rgba(255, 255, 255, 0.9);
      --button-bg: linear-gradient(135deg, #3a7bd5, #00d2ff);
      --button-color: white;
      --dropdown-bg: rgba(255, 255, 255, 0.95);
      --modal-bg: rgba(255, 255, 255, 0.95);
      --modal-shadow: rgba(0, 0, 0, 0.15);
      --overlay-bg: rgba(0, 0, 0, 0.4);
      --error-color: #e53e3e;
      --wave-bg: rgba(0, 0, 0, 0.03);
      --wave-bar: #3a7bd5;
      --timestamp-bg: rgba(0, 0, 0, 0.05);
      --scrollbar-track: rgba(0, 0, 0, 0.05);
      --scrollbar-thumb: rgba(0, 0, 0, 0.1);
      --scrollbar-thumb-hover: rgba(0, 0, 0, 0.2);
      --voice-btn-bg: rgba(240, 240, 240, 0.8);
      --voice-btn-color: #4a5568;
      --voice-btn-active: #3a7bd5;
      --btn-secondary-bg: rgba(240, 240, 240, 0.8);
      --btn-secondary-color: #4a5568;
      --btn-secondary-hover: rgba(224, 224, 224, 0.9);
      --dropdown-hover: rgba(245, 245, 245, 0.9);
      --dropdown-border: rgba(240, 240, 240, 0.8);
      --context-info-bg: rgba(255, 255, 255, 0.8);
      --sidebar-bg: #1a1f36;
      --sidebar-text: #ffffff;
      --sidebar-hover: rgba(255, 255, 255, 0.1);
      --sidebar-selected: rgba(255, 255, 255, 0.15);
      --sidebar-border: rgba(77, 77, 79, 0.3);
      --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      --input-border: rgba(226, 232, 240, 0.8);
      --input-focus-border: #3a7bd5;
      --input-focus-shadow: rgba(58, 123, 213, 0.2);
      --accent-color: #3a7bd5;
      --accent-gradient: linear-gradient(135deg, #3a7bd5, #00d2ff);
      --card-bg: rgba(255, 255, 255, 0.7);
      --glow-effect: 0 0 15px rgba(58, 123, 213, 0.3);
    }
    .dark-mode {
      /* 暗色模式变量 - 未来科技感配色 */
      --bg-color: #0f172a;
      --container-bg: rgba(30, 41, 59, 0.8);
      --header-bg: rgba(30, 41, 59, 0.9);
      --header-color: #e2e8f0;
      --chat-bg: #0f172a;
      --text-color: #e2e8f0;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --border-color: rgba(51, 65, 85, 0.5);
      --user-bubble: linear-gradient(135deg, #3a7bd5, #00d2ff);
      --user-text: #ffffff;
      --bot-bubble: rgba(30, 41, 59, 0.9);
      --input-bg: rgba(30, 41, 59, 0.8);
      --button-bg: linear-gradient(135deg, #3a7bd5, #00d2ff);
      --button-color: white;
      --dropdown-bg: rgba(30, 41, 59, 0.95);
      --modal-bg: rgba(30, 41, 59, 0.95);
      --modal-shadow: rgba(0, 0, 0, 0.4);
      --overlay-bg: rgba(0, 0, 0, 0.6);
      --error-color: #f56565;
      --wave-bg: rgba(255, 255, 255, 0.05);
      --wave-bar: #3a7bd5;
      --timestamp-bg: rgba(255, 255, 255, 0.1);
      --scrollbar-track: rgba(255, 255, 255, 0.05);
      --scrollbar-thumb: rgba(255, 255, 255, 0.1);
      --scrollbar-thumb-hover: rgba(255, 255, 255, 0.2);
      --voice-btn-bg: rgba(51, 65, 85, 0.8);
      --voice-btn-color: #e2e8f0;
      --voice-btn-active: #3a7bd5;
      --btn-secondary-bg: rgba(51, 65, 85, 0.8);
      --btn-secondary-color: #e2e8f0;
      --btn-secondary-hover: rgba(71, 85, 105, 0.9);
      --dropdown-hover: rgba(51, 65, 85, 0.9);
      --dropdown-border: rgba(71, 85, 105, 0.5);
      --context-info-bg: rgba(0, 0, 0, 0.3);
      --sidebar-bg: #0f172a;
      --sidebar-text: #e2e8f0;
      --sidebar-hover: rgba(255, 255, 255, 0.1);
      --sidebar-selected: rgba(255, 255, 255, 0.15);
      --sidebar-border: rgba(77, 77, 79, 0.3);
      --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      --input-border: rgba(51, 65, 85, 0.8);
      --input-focus-border: #3a7bd5;
      --input-focus-shadow: rgba(58, 123, 213, 0.4);
      --accent-color: #3a7bd5;
      --accent-gradient: linear-gradient(135deg, #3a7bd5, #00d2ff);
      --card-bg: rgba(30, 41, 59, 0.7);
      --glow-effect: 0 0 15px rgba(58, 123, 213, 0.3);
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Inter", "Söhne", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", sans-serif, "Helvetica Neue", Arial;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s, box-shadow 0.3s;
    }
    html {
      scroll-behavior: smooth;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    html::-webkit-scrollbar {
      display: none;
    }
    body {
      background-color: var(--bg-color);
      background-image:
        radial-gradient(circle at 10% 20%, rgba(58, 123, 213, 0.05) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(0, 210, 255, 0.05) 0%, transparent 20%);
      height: 100vh;
      display: flex;
      color: var(--text-color);
      overflow: hidden;
    }
    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
    }
    /* 侧边栏样式 */
    .sidebar {
      width: 280px;
      background: var(--sidebar-bg);
      background-image: linear-gradient(180deg, rgba(58, 123, 213, 0.1) 0%, rgba(0, 0, 0, 0) 100%);
      color: var(--sidebar-text);
      display: flex;
      flex-direction: column;
      height: 100%;
      border-right: 1px solid var(--sidebar-border);
      transition: transform 0.3s ease;
      z-index: 20;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 5px 0 15px rgba(0, 0, 0, 0.05);
    }
    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--sidebar-border);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .new-chat-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--sidebar-border);
      border-radius: 8px;
      color: var(--sidebar-text);
      padding: 12px 16px;
      width: 100%;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .new-chat-btn:hover {
      background-color: var(--sidebar-hover);
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }
    .new-chat-btn svg {
      width: 16px;
      height: 16px;
    }
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
    }
    .chat-history-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      border-radius: 8px;
      margin: 3px 10px;
      font-size: 14px;
      color: var(--sidebar-text);
      transition: all 0.2s ease;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .chat-history-item:hover {
      background-color: var(--sidebar-hover);
      transform: translateX(2px);
    }
    .chat-history-item.active {
      background-color: var(--sidebar-selected);
      border-left: 3px solid var(--accent-color);
    }
    .chat-history-item svg {
      width: 16px;
      height: 16px;
      margin-right: 10px;
      flex-shrink: 0;
    }
    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid var(--sidebar-border);
    }
    .sidebar-user {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      cursor: pointer;
      padding: 10px;
      border-radius: 8px;
      transition: background-color 0.2s;
    }
    .sidebar-user:hover {
      background-color: var(--sidebar-hover);
    }
    .sidebar-user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: var(--accent-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .sidebar-user-avatar svg {
      width: 24px;
      height: 24px;
      display: block;
    }
    .sidebar-user-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 500;
    }
    /* 主内容区 */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
      background-image:
        radial-gradient(circle at 90% 10%, rgba(58, 123, 213, 0.03) 0%, transparent 30%),
        radial-gradient(circle at 10% 90%, rgba(0, 210, 255, 0.03) 0%, transparent 30%);
    }
    .header {
      padding: 16px 24px;
      background: var(--header-bg);
      color: var(--header-color);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
      height: 70px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
    }
    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
    }
    .header-buttons {
      display: flex;
      gap: 12px;
    }
    .theme-toggle, .menu-button {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    .theme-toggle:hover, .menu-button:hover {
      background-color: var(--dropdown-hover);
      transform: translateY(-2px);
      box-shadow: var(--box-shadow);
    }
    /* 聊天区域 */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      display: flex;
      flex-direction: column;
      background-color: var(--chat-bg);
      scroll-behavior: smooth;
    }
    .message-group {
      display: flex;
      flex-direction: column;
      width: 100%;
    }
    .message-row {
      display: flex;
      padding: 22px;
      transition: background-color 0.2s;
    }
    .message-row.user-message {
      background-color: var(--container-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .message-row.bot-message {
      background-color: var(--bot-bubble);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .message-container {
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      gap: 20px;
    }
    /* 头像容器 */
    .avatar-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 16px;
      flex-shrink: 0;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
      position: relative;
      overflow: hidden;
    }
    .user-avatar {
      background: var(--user-bubble);
      background-size: cover;
      background-position: center;
    }
    .bot-avatar {
      background: var(--accent-gradient);
      position: relative;
    }
    .bot-avatar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 40%, rgba(255, 255, 255, 0.2) 50%, transparent 60%);
      background-size: 200% 200%;
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      0% { background-position: 100% 100%; }
      100% { background-position: 0% 0%; }
    }
    .assistant-name {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }
    .message-content {
      flex: 1;
      font-size: 16px;
      line-height: 1.6;
      overflow-wrap: break-word;
    }
    .user-content {
      color: var(--text-color);
    }
    .bot-content {
      color: var(--text-color);
    }
    .audio-container {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 18px;
      max-width: 400px;
      background-color: var(--wave-bg);
      border-radius: 24px;
      padding: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.2s ease;
    }
    .audio-container:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }
    .voice-wave {
      flex: 1;
      height: 44px;
      border-radius: 20px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      padding: 0 15px;
    }
    .voice-wave:hover {
      background-color: rgba(58, 123, 213, 0.1);
    }
    .wave-animation {
      height: 100%;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .bar {
      background: var(--accent-gradient);
      height: 70%;
      width: 3px;
      border-radius: 3px;
      animation: sound 0ms -800ms linear infinite alternate;
      box-shadow: 0 0 3px rgba(58, 123, 213, 0.3);
    }
    @keyframes sound {
      0% { height: 10%; }
      100% { height: 80%; }
    }
    .bar:nth-child(1) { animation-duration: 474ms; }
    .bar:nth-child(2) { animation-duration: 433ms; }
    .bar:nth-child(3) { animation-duration: 407ms; }
    .bar:nth-child(4) { animation-duration: 458ms; }
    .bar:nth-child(5) { animation-duration: 400ms; }
    .bar:nth-child(6) { animation-duration: 427ms; }
    .bar:nth-child(7) { animation-duration: 441ms; }
    .bar:nth-child(8) { animation-duration: 419ms; }
    .bar:nth-child(9) { animation-duration: 487ms; }
    .bar:nth-child(10) { animation-duration: 442ms; }
    .voice-duration {
      font-size: 13px;
      color: var(--text-secondary);
      min-width: 40px;
      text-align: right;
      padding-right: 10px;
      font-weight: 500;
    }
    .play-button {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--accent-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-left: 8px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
      transition: all 0.2s;
    }
    .play-button:hover {
      transform: scale(1.08);
      box-shadow: var(--glow-effect);
    }
    .play-button svg {
      width: 16px;
      height: 16px;
      fill: white;
    }
    /* 下载按钮样式 */
    .download-btn {
      background-color: var(--btn-secondary-bg);
      color: var(--btn-secondary-color);
      border: none;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
    .download-btn:hover {
      background-color: var(--btn-secondary-hover);
      transform: translateY(-1px);
    }
    /* 新增：语音转文本按钮样式 */
    .transcribe-btn {
      background-color: var(--btn-secondary-bg);
      color: var(--btn-secondary-color);
      border: none;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      margin-left: 8px;
    }
    .transcribe-btn:hover {
      background-color: var(--btn-secondary-hover);
      transform: translateY(-1px);
    }
    /* 新增：转录文本容器样式 */
    .transcript-container {
      margin-top: 12px;
      padding: 12px 16px;
      background-color: var(--wave-bg);
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-color);
      border-left: 3px solid var(--accent-color);
    }
    .transcript-loading {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-style: italic;
    }
    .transcript-loading .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(58, 123, 213, 0.3);
      border-radius: 50%;
      border-top-color: var(--accent-color);
      animation: spin 1s ease-in-out infinite;
    }
    .input-area {
      padding: 11px 24px 14px;
      border-top: 1px solid var(--border-color);
      background-color: var(--container-bg);
      z-index: 5;
      display: flex;
      flex-direction: column;
      align-items: center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    /* 输入区域布局 */
    .input-container {
      max-width: 900px;
      width: 100%;
    }
    .input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    /* 修改后的布局：只显示两个图标按钮 */
     .input-left {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .voice-btn, .context-btn {
      border: none;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      cursor: pointer;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-color);
      transition: all 0.2s ease;
    }
    .voice-btn:hover, .context-btn:hover {
      background-color: var(--dropdown-hover);
      transform: translateY(-2px);
      box-shadow: var(--box-shadow);
    }
    .input-right {
      flex: 1;
      position: relative;
    }
    .input-field {
      width: 100%;
      border: 1px solid var(--input-border);
      border-radius: 12px;
      padding: 14px 50px 14px 18px;
      font-size: 16px;
      outline: none;
      background-color: var(--input-bg);
      color: var(--text-color);
      resize: none;
      min-height: 45px;
      max-height: 200px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
      overflow-y: auto;
      line-height: 1;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
    .input-field:focus {
      border-color: var(--input-focus-border);
      box-shadow: 0 0 0 3px var(--input-focus-shadow), 0 2px 8px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }
    .input-buttons {
      position: absolute;
      right: 10px;
      top: 40%;
      transform: translateY(-50%);
      display: flex;
      gap: 8px;
    }
    .send-btn {
      border: none;
      border-radius: 10px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: transparent;
      color: var(--accent-color);
    }
    .send-btn:hover {
      background-color: var(--wave-bg);
      transform: translateY(-2px);
    }
    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .send-icon {
      width: 20px;
      height: 20px;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(58, 123, 213, 0.3);
      border-radius: 50%;
      border-top-color: var(--accent-color);
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .timestamp {
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
      margin: 10px 0;
      padding: 5px 12px;
      border-radius: 12px;
      display: inline-block;
      align-self: center;
      background-color: var(--timestamp-bg);
            backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .paused .bar { animation-play-state: paused; }
    .playing .bar { animation-play-state: running; }
    .error-message {
      color: var(--error-color);
      margin-top: 8px;
      font-size: 14px;
      padding: 10px 14px;
      background-color: rgba(229, 62, 62, 0.1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      box-shadow: 0 2px 5px rgba(229, 62, 62, 0.1);
    }
    .error-message svg { width: 16px; height: 16px; fill: var(--error-color); }
        .context-info {
      font-size: 13px;
      color: var(--text-secondary);
      text-align: center;
      padding: 8px 14px;
      background-color: var(--context-info-bg);
      border-radius: 15px;
      margin: 12px auto;
      max-width: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .context-info svg { width: 14px; height: 14px; }
    .dropdown-menu {
      position: absolute;
      top: 55px;
      right: 15px;
      background-color: var(--dropdown-bg);
      border-radius: 12px;
      box-shadow: var(--box-shadow);
      z-index: 10;
      display: none;
      overflow: hidden;
      width: 220px;
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .dropdown-menu.active {
      display: block;
      animation: dropdownFadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes dropdownFadeIn {
      from { opacity: 0; transform: translateY(-10px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .dropdown-item {
      padding: 14px 18px;
      font-size: 14px;
      color: var(--text-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    .dropdown-item:hover {
      background-color: var(--dropdown-hover);
      transform: translateX(2px);
    }
    .dropdown-icon {
      width: 18px;
      height: 18px;
      fill: var(--text-secondary);
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--overlay-bg);
      z-index: 100;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
    .modal {
      background-color: var(--modal-bg);
      border-radius: 16px;
      width: 90%;
      max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px var(--modal-shadow);
      padding: 28px;
      position: relative;
      animation: modalFadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--border-color);
    }
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(30px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 18px;
      border-bottom: 1px solid var(--border-color);
    }
    .modal-title {
      font-size: 20px;
      color: var(--text-color);
      font-weight: 600;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      transition: all 0.2s ease;
    }
    .close-btn:hover {
      background-color: var(--btn-secondary-bg);
      color: var(--text-secondary);
      transform: rotate(90deg);
    }
    .modal-body {
      margin-bottom: 28px;
      color: var(--text-color);
      line-height: 1.6;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 14px;
      padding-top: 18px;
      border-top: 1px solid var(--border-color);
    }
    .modal-btn {
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .btn-primary {
      background: var(--button-bg);
      color: var(--button-color);
    }
    .btn-primary:hover {
      opacity: 0.9;
      box-shadow: var(--glow-effect);
      transform: translateY(-2px);
    }
    .btn-secondary {
      background-color: var(--btn-secondary-bg);
      color: var(--btn-secondary-color);
    }
    .btn-secondary:hover {
      background-color: var(--btn-secondary-hover);
      transform: translateY(-2px);
    }
    /* 自定义滚动条 */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: var(--scrollbar-track);
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--scrollbar-thumb);
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--scrollbar-thumb-hover);
    }
    /* 移动端适配 */
    @media (max-width: 992px) {
      .sidebar {
        position: fixed;
        left: -280px;
        top: 0;
        bottom: 0;
        width: 280px;
        z-index: 30;
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .sidebar.active { transform: translateX(280px); }
      .mobile-menu-btn { display: block; }
      .overlay-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--overlay-bg);
        z-index: 25;
        display: none;
        backdrop-filter: blur(3px);
        -webkit-backdrop-filter: blur(3px);
      }
      .overlay-sidebar.active { display: block; }
    }
    @media (max-width: 768px) {
      .message-container { gap: 14px; }
      .avatar { width: 36px; height: 36px; font-size: 14px; }
      .message-content { font-size: 15px; }
      .input-area { padding: 14px 18px 18px; }
      .input-field { padding: 12px 50px 12px 16px; font-size: 15px; min-height: 52px; }
      .modal { width: 95%; padding: 22px; }
      .dropdown-menu { width: 200px; }
      .header { padding: 14px 18px; height: 65px; }
      .header-title { font-size: 15px; }
      select { font-size: 14px; padding: 8px 10px; }
      .voice-btn, .context-btn { width: 30px; height: 30px; }
    }
    @media (max-width: 480px) {
      .message-row { padding: 18px 14px; }
      .message-container { gap: 12px; }
      .avatar { width: 32px; height: 32px; }
      .message-content { font-size: 14px; }
      .timestamp { font-size: 11px; padding: 3px 10px; }
      .audio-container { max-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <button class="new-chat-btn" id="newChatBtn">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          新对话
        </button>
        <button class="new-chat-btn" id="deleteAllBtn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6l-1 14H6L5 6"/>
            <path d="M10 11v6"/>
            <path d="M14 11v6"/>
            <path d="M9 6V4h6v2"/>
          </svg>
          删除所有对话
        </button>
      </div>
      <div class="sidebar-content" id="sidebarContent">
        <!-- 会话列表在这里动态生成 -->
      </div>
      <div class="sidebar-footer">
        <div class="sidebar-user" id="userBtn">
          <div class="sidebar-user-avatar">
            <!-- 简单默认SVG头像 -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" fill="#10a37f"/>
              <path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm0 2c-5 0-8 2.5-8 4v2h16v-2c0-1.5-3-4-8-4z" fill="#ffffff"/>
            </svg>
          </div>
          <div class="sidebar-user-name">用户</div>
        </div>
      </div>
    </div>
    <div class="overlay-sidebar" id="overlaySidebar"></div>
    <div class="main-content">
      <div class="header">
        <div class="header-title">
          <button class="mobile-menu-btn" id="mobileMenuBtn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <h2>Free AI 语音聊天助手</h2>
        </div>
        <div class="header-buttons">
          <button class="theme-toggle" id="themeToggle">
            <svg class="theme-icon" id="lightIcon" viewBox="0 0 24 24" style="display: none;">
              <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
            </svg>
            <svg class="theme-icon" id="darkIcon" viewBox="0 0 24 24">
              <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>
            </svg>
          </button>
          <button class="menu-button" id="menuButton">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path d="M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12 6C12.5523 6 13 5.55228 13 5C13 4.44772 12.5523 4 12 4C11.4477 4 11 4.44772 11 5C11 5.55228 11.4477 6 12 6Z" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12 20C12.5523 20 13 19.5523 13 19C13 18.4477 12.5523 18 12 18C11.4477 18 11 18.4477 11 19C11 19.5523 11.4477 20 12 20Z" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="dropdown-menu" id="dropdownMenu">
            <div class="dropdown-item" id="exportChat">
              <svg class="dropdown-icon" viewBox="0 0 24 24">
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
              </svg>
              导出聊天记录
            </div>
            <div class="dropdown-item" id="clearChat">
              <svg class="dropdown-icon" viewBox="0 0 24 24">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
              </svg>
              清空聊天记录
            </div>
            <div class="dropdown-item" id="settingsItem">
              <svg class="dropdown-icon" viewBox="0 0 24 24">
                <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22l-1.92 3.32c-.12.22-.07.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
              </svg>
              设置
            </div>
          </div>
        </div>
      </div>
      <div class="chat-container">
        <div class="chat-area" id="chatArea">
          <div class="timestamp">今天 <span id="currentTime"></span></div>
        </div>
        <div class="input-area">
          <div class="input-container">
            <div class="input-wrapper">
              <div class="input-left">
                <button class="voice-btn" id="voiceBtn">
                  <svg viewBox="0 0 24 24" width="20" height="20">
                    <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3z" fill="none" stroke="currentColor" stroke-width="2"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2" fill="none" stroke="currentColor" stroke-width="2"/>
                    <line x1="12" y1="19" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
                <button class="context-btn" id="contextBtn">
                  <svg viewBox="0 0 24 24" width="20" height="20">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2z" fill="none" stroke="currentColor" stroke-width="2"/>
                  </svg>
                </button>
              </div>
              <div class="input-right">
                <textarea class="input-field" id="messageInput" placeholder="输入消息..." rows="1"></textarea>
                <div class="input-buttons">
                  <button class="send-btn" id="sendBtn">
                    <svg class="send-icon" viewBox="0 0 24 24" fill="none">
                      <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                </div>
                <center><p><font size="1" color="#888888">
                  Tips：请先点击左侧"新对话"按钮，开启对话。
                </font></p></center>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- 导出对话模态框 -->
  <div class="overlay" id="exportModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">导出聊天记录</h3>
        <button class="close-btn" id="closeExportModal">×</button>
      </div>
      <div class="modal-body">
        <p>聊天记录将以HTML格式导出，包含可播放的语音。</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn btn-secondary" id="cancelExport">取消</button>
        <button class="modal-btn btn-primary" id="confirmExport">导出</button>
      </div>
    </div>
  </div>
  <!-- 清空确认模态框 -->
  <div class="overlay" id="clearModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">确认清空聊天记录</h3>
        <button class="close-btn" id="closeClearModal">×</button>
      </div>
      <div class="modal-body">
        <p>确定要清空当前对话聊天记录吗？此操作不可恢复。</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn btn-secondary" id="cancelClear">取消</button>
        <button class="modal-btn btn-primary" id="confirmClear">确认清空</button>
      </div>
    </div>
  </div>
  <!-- 设置模态框 -->
  <div class="overlay" id="settingsModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">设置</h3>
        <button class="close-btn" id="closeSettingsModal">×</button>
      </div>
      <div class="modal-body">
        <div style="margin-top:18px;">
          <label for="defaultVoiceSelect">默认语音：</label>
          <select id="defaultVoiceSelect">
            <option value="alloy">Alloy - 平稳中性</option>
            <option value="echo">Echo - 深沉有力</option>
            <option value="fable">Fable - 温和舒适</option>
            <option value="onyx">Onyx - 坚定严肃</option>
            <option value="nova">Nova - 热情活力</option>
            <option value="shimmer">Shimmer - 清脆明亮</option>
            <option value="coral">Coral - 温暖亲切</option>
            <option value="verse">Verse - 抒情优雅</option>
            <option value="ballad">Ballad - 柔和深情</option>
            <option value="ash">Ash - 冷静理智</option>
            <option value="sage">Sage - 智慧沉稳</option>
            <option value="amuch">Amuch - 亲切友好</option>
            <option value="dan">Dan - 自信专业</option>
          </select>
        </div>
        
        <!-- 新增：语音转文本设置 -->
        <div style="margin-top:18px;">
          <h4>语音转文本设置</h4>
          <div style="margin-top:10px;">
            <label for="sttApiSelect">语音转文本服务：</label>
            <select id="sttApiSelect">
              <option value="openai">OpenAI Whisper</option>
              <option value="azure">Azure 语音服务</option>
              <option value="google">Google Speech-to-Text</option>
              <option value="baidu">百度语音识别</option>
              <option value="xfyun">讯飞语音识别</option>
              <option value="ibm">IBM Watson</option>
              <option value="assembly">AssemblyAI（推荐）</option>
              <option value="custom">自定义服务</option>
            </select>
          </div>
          
          <div id="openaiApiSettings" style="margin-top:10px;">
            <label for="openaiApiKey">OpenAI API Key：</label>
            <input type="password" id="openaiApiKey" placeholder="输入您的OpenAI API Key" style="width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid var(--border-color);">
          </div>
          
          <div id="azureApiSettings" style="margin-top:10px; display:none;">
            <label for="azureApiKey">Azure API Key：</label>
            <input type="password" id="azureApiKey" placeholder="输入您的Azure API Key" style="width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid var(--border-color);">
            <label for="azureRegion" style="margin-top:10px; display:block;">区域：</label>
            <input type="text" id="azureRegion" placeholder="例如: eastasia" style="width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid var(--border-color);">
          </div>
          
          <div id="googleApiSettings" style="margin-top:10px; display:none;">
            <label for="googleApiKey">Google API Key：</label>
            <input type="password" id="googleApiKey" placeholder="输入您的Google API Key" style="width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid var(--border-color);">
          </div>
          
          <div id="baiduApiSettings" style="margin-top:10px; display:none;">
            <label for="baiduApiKey">百度API Key：</label>
            <input type="password" id="baiduApiKey" placeholder="输入您的百度API Key" style="width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid var(--border-color);">
            <label for="baiduSecretKey" style="margin-top:10px; display:block;">Secret Key：</label>
            <input type="password" id="baiduSecretKey" placeholder="输入您的百度Secret Key" style="width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid var(--border-color);">
          </div>
          
          <div id="xfyunApiSettings" style="margin-top:10px; display:none;">
            <label for="xfyunAppId">
            <label for="xfyunAppId">讯飞APPID：</label>
            <input type="text" id="xfyunAppId" placeholder="输入您的讯飞APPID" style="width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid var(--border-color);">
            <label for="xfyunApiKey" style="margin-top:10px; display:block;">API Key：</label>
            <input type="password" id="xfyunApiKey" placeholder="输入您的讯飞API Key" style="width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid var(--border-color);">
            <label for="xfyunApiSecret" style="margin-top:10px; display:block;">API Secret：</label>
            <input type="password" id="xfyunApiSecret" placeholder="输入您的讯飞API Secret" style="width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid var(--border-color);">
          </div>
          
          <div id="ibmApiSettings" style="margin-top:10px; display:none;">
            <label for="ibmApiKey">IBM API Key：</label>
            <input type="password" id="ibmApiKey" placeholder="输入您的IBM API Key" style="width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid var(--border-color);">
            <label for="ibmServiceUrl" style="margin-top:10px; display:block;">服务URL：</label>
            <input type="text" id="ibmServiceUrl" placeholder="输入IBM Watson服务URL" style="width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid var(--border-color);">
          </div>
          
          <div id="assemblyApiSettings" style="margin-top:10px; display:none;">
            <label for="assemblyApiKey">AssemblyAI API Key：</label>
            <input type="password" id="assemblyApiKey" placeholder="输入您的AssemblyAI API Key" style="width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid var(--border-color);">
          </div>
          
          <div id="customApiSettings" style="margin-top:10px; display:none;">
            <label for="customApiUrl">自定义API地址：</label>
            <input type="text" id="customApiUrl" placeholder="输入API地址" style="width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid var(--border-color);">
            
            <label for="customApiKey" style="margin-top:10px; display:block;">API Key：</label>
            <input type="password" id="customApiKey" placeholder="输入API Key" style="width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid var(--border-color);">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn btn-primary" id="saveSettings">保存</button>
      </div>
    </div>
  </div>
  <!-- 公告模态框 -->
  <div class="overlay" id="announcementModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">关于</h3>
        <button class="close-btn" id="closeAnnouncementModal">×</button>
      </div>
      <div class="modal-body">
        <p style="font-size: 14px; color: var(--text-color);">
        <i class="fas fa-info-circle" style="color: var(--accent-color);"></i>
        本项目由 <a href="https://other.azad.asia" target="_blank" style="color: var(--accent-color); text-decoration: none;">Azad</a> 开发
      &nbsp; &nbsp; <i class="fas fa-robot" style="color: var(--accent-color);"></i>
        基于 <a href="https://pollinations.ai" target="_blank" style="color: var(--accent-color); text-decoration: none;">Pollinations.AI</a> 提供服务
<br><br>
<i class="fab fa-github" style="color: var(--accent-color);"></i> 项目开源地址
        <a href="https://github.com/Azad-sl/FreeAI" target="_blank" style="color: var(--accent-color); text-decoration: none;">Github</a> &nbsp; &nbsp;
<i class="fas fa-medal" style="color: var(--accent-color);"></i> 给站长
        <a href="https://home.azad.asia/ds" target="_blank" style="color: var(--accent-color); text-decoration: none;">加个鸡腿</a>
    </p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn btn-primary" id="closeAnnouncementConfirm">我知道了</button>
      </div>
    </div>
  </div>
  <!-- 新增语音选择模态框 -->
  <div class="overlay" id="voiceModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">选择语音助手</h3>
        <button class="close-btn" id="closeVoiceModal">×</button>
      </div>
      <div class="modal-body">
        <p>请选择要使用的语音助手：</p>
        <select id="modalVoiceSelect">
          <option value="alloy">Alloy - 平稳中性</option>
          <option value="echo">Echo - 深沉有力</option>
          <option value="fable">Fable - 温和舒适</option>
          <option value="onyx">Onyx - 坚定严肃</option>
          <option value="nova">Nova - 热情活力</option>
          <option value="shimmer">Shimmer - 清脆明亮</option>
          <option value="coral">Coral - 温暖亲切</option>
          <option value="verse">Verse - 抒情优雅</option>
          <option value="ballad">Ballad - 柔和深情</option>
          <option value="ash">Ash - 冷静理智</option>
          <option value="sage">Sage - 智慧沉稳</option>
          <option value="amuch">Amuch - 亲切友好</option>
          <option value="dan">Dan - 自信专业</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="modal-btn btn-secondary" id="cancelVoiceModal">取消</button>
        <button class="modal-btn btn-primary" id="confirmVoiceModal">确定</button>
      </div>
    </div>
  </div>
    <!-- 新增上下文选择模态框 -->
  <div class="overlay" id="contextModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">选择上下文消息条数</h3>
        <button class="close-btn" id="closeContextModal">×</button>
      </div>
      <div class="modal-body">
        <p>请选择读取多少条上下文消息：</p>
        <select id="modalContextSelect">
          <option value="0">不读取上下文</option>
          <option value="5">读取前5条消息</option>
          <option value="10">读取前10条消息</option>
        </select>
      </div>
      <div class="modal-footer">
        <button class="modal-btn btn-secondary" id="cancelContextModal">取消</button>
        <button class="modal-btn btn-primary" id="confirmContextModal">确定</button>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 全局变量：记录所有会话、当前会话ID、存储 key、默认语音 key
      let conversations = [];
      let currentConversationId = null;
      const STORAGE_KEY = 'voiceConversations';
      const defaultVoiceKey = 'defaultVoice';
      const sttSettingsKey = 'sttSettings'; // 新增：语音转文本设置存储key
      
      // DOM 对象
      const chatArea = document.getElementById('chatArea');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const voiceSelect = document.getElementById('defaultVoiceSelect'); // 使用默认设置中的select
      const contextSelect = document.getElementById('modalContextSelect'); // 从模态框中取值
      const menuButton = document.getElementById('menuButton');
      const dropdownMenu = document.getElementById('dropdownMenu');
      const exportChat = document.getElementById('exportChat');
      const clearChat = document.getElementById('clearChat');
      const settingsItem = document.getElementById('settingsItem');
      const exportModal = document.getElementById('exportModal');
      const clearModal = document.getElementById('clearModal');
      const settingsModal = document.getElementById('settingsModal');
      const closeExportModal = document.getElementById('closeExportModal');
      const cancelExport = document.getElementById('cancelExport');
      const confirmExport = document.getElementById('confirmExport');
      const closeClearModal = document.getElementById('closeClearModal');
      const cancelClear = document.getElementById('cancelClear');
      const confirmClear = document.getElementById('confirmClear');
      const closeSettingsModal = document.getElementById('closeSettingsModal');
      const saveSettings = document.getElementById('saveSettings');
      const themeToggle = document.getElementById('themeToggle');
      const lightIcon = document.getElementById('lightIcon');
      const darkIcon = document.getElementById('darkIcon');
      const sidebar = document.getElementById('sidebar');
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const overlaySidebar = document.getElementById('overlaySidebar');
      const newChatBtn = document.getElementById('newChatBtn');
      const deleteAllBtn = document.getElementById('deleteAllBtn');
      const sidebarContent = document.getElementById('sidebarContent');
      const defaultVoiceSelect = document.getElementById('defaultVoiceSelect');
      const userBtn = document.getElementById('userBtn');
      const announcementModal = document.getElementById('announcementModal');
      const closeAnnouncementModal = document.getElementById('closeAnnouncementModal');
      const closeAnnouncementConfirm = document.getElementById('closeAnnouncementConfirm');
      // 新增：模态框元素对象
      const voiceModal = document.getElementById('voiceModal');
      const closeVoiceModal = document.getElementById('closeVoiceModal');
      const cancelVoiceModal = document.getElementById('cancelVoiceModal');
      const confirmVoiceModal = document.getElementById('confirmVoiceModal');
      const modalVoiceSelect = document.getElementById('modalVoiceSelect');
      const contextModal = document.getElementById('contextModal');
      const closeContextModal = document.getElementById('closeContextModal');
      const cancelContextModal = document.getElementById('cancelContextModal');
      const confirmContextModal = document.getElementById('confirmContextModal');
      const modalContextSelect = document.getElementById('modalContextSelect');
      
      // 新增：语音转文本设置相关元素
      const sttApiSelect = document.getElementById('sttApiSelect');
      const openaiApiSettings = document.getElementById('openaiApiSettings');
      const azureApiSettings = document.getElementById('azureApiSettings');
      const googleApiSettings = document.getElementById('googleApiSettings');
      const baiduApiSettings = document.getElementById('baiduApiSettings');
      const xfyunApiSettings = document.getElementById('xfyunApiSettings');
      const ibmApiSettings = document.getElementById('ibmApiSettings');
      const assemblyApiSettings = document.getElementById('assemblyApiSettings');
      const customApiSettings = document.getElementById('customApiSettings');
      const openaiApiKey = document.getElementById('openaiApiKey');
      const azureApiKey = document.getElementById('azureApiKey');
      const azureRegion = document.getElementById('azureRegion');
      const googleApiKey = document.getElementById('googleApiKey');
      const baiduApiKey = document.getElementById('baiduApiKey');
      const baiduSecretKey = document.getElementById('baiduSecretKey');
      const xfyunAppId = document.getElementById('xfyunAppId');
      const xfyunApiKey = document.getElementById('xfyunApiKey');
      const xfyunApiSecret = document.getElementById('xfyunApiSecret');
      const ibmApiKey = document.getElementById('ibmApiKey');
      const ibmServiceUrl = document.getElementById('ibmServiceUrl');
      const assemblyApiKey = document.getElementById('assemblyApiKey');
      const customApiUrl = document.getElementById('customApiUrl');
      const customApiKey = document.getElementById('customApiKey');
      
      // 设置当前时间
      const now = new Date();
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      document.getElementById('currentTime').textContent = `${hours}:${minutes}`;
      
      // 主题设置
      const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
      const currentTheme = localStorage.getItem('theme');
      if (currentTheme === 'dark' || (!currentTheme && prefersDarkScheme.matches)) {
        document.documentElement.classList.add('dark-mode');
        lightIcon.style.display = 'block';
        darkIcon.style.display = 'none';
      } else {
        document.documentElement.classList.remove('dark-mode');
        lightIcon.style.display = 'none';
        darkIcon.style.display = 'block';
      }
      
      // 加载语音转文本设置
      let sttSettings = JSON.parse(localStorage.getItem(sttSettingsKey)) || {
        service: 'openai',
        openaiApiKey: '',
        azureApiKey: '',
        azureRegion: '',
        googleApiKey: '',
        baiduApiKey: '',
        baiduSecretKey: '',
        xfyunAppId: '',
        xfyunApiKey: '',
        xfyunApiSecret: '',
        ibmApiKey: '',
        ibmServiceUrl: '',
        assemblyApiKey: '',
        customApiUrl: '',
        customApiKey: ''
      };
      
      // 初始化语音转文本设置界面
      sttApiSelect.value = sttSettings.service;
      openaiApiKey.value = sttSettings.openaiApiKey || '';
      azureApiKey.value = sttSettings.azureApiKey || '';
      azureRegion.value = sttSettings.azureRegion || '';
      googleApiKey.value = sttSettings.googleApiKey || '';
      baiduApiKey.value = sttSettings.baiduApiKey || '';
      baiduSecretKey.value = sttSettings.baiduSecretKey || '';
      xfyunAppId.value = sttSettings.xfyunAppId || '';
      xfyunApiKey.value = sttSettings.xfyunApiKey || '';
      xfyunApiSecret.value = sttSettings.xfyunApiSecret || '';
      ibmApiKey.value = sttSettings.ibmApiKey || '';
      ibmServiceUrl.value = sttSettings.ibmServiceUrl || '';
      assemblyApiKey.value = sttSettings.assemblyApiKey || '';
      customApiUrl.value = sttSettings.customApiUrl || '';
      customApiKey.value = sttSettings.customApiKey || '';
      
      // 根据选择的服务显示对应设置
      function updateSttSettingsVisibility() {
        openaiApiSettings.style.display = 'none';
        azureApiSettings.style.display = 'none';
        googleApiSettings.style.display = 'none';
        baiduApiSettings.style.display = 'none';
        xfyunApiSettings.style.display = 'none';
        ibmApiSettings.style.display = 'none';
        assemblyApiSettings.style.display = 'none';
        customApiSettings.style.display = 'none';
        
        switch(sttApiSelect.value) {
          case 'openai':
            openaiApiSettings.style.display = 'block';
            break;
          case 'azure':
            azureApiSettings.style.display = 'block';
            break;
          case 'google':
            googleApiSettings.style.display = 'block';
            break;
          case 'baidu':
            baiduApiSettings.style.display = 'block';
            break;
          case 'xfyun':
            xfyunApiSettings.style.display = 'block';
            break;
          case 'ibm':
            ibmApiSettings.style.display = 'block';
            break;
          case 'assembly':
            assemblyApiSettings.style.display = 'block';
            break;
          case 'custom':
            customApiSettings.style.display = 'block';
            break;
        }
      }
      
      // 初始调用一次
      updateSttSettingsVisibility();
      
      // 切换语音转文本服务类型
      sttApiSelect.addEventListener('change', updateSttSettingsVisibility);
      
      themeToggle.addEventListener('click', function() {
        if (document.documentElement.classList.contains('dark-mode')) {
          document.documentElement.classList.remove('dark-mode');
          localStorage.setItem('theme', 'light');
          lightIcon.style.display = 'none';
          darkIcon.style.display = 'block';
        } else {
          document.documentElement.classList.add('dark-mode');
          localStorage.setItem('theme', 'dark');
          lightIcon.style.display = 'block';
          darkIcon.style.display = 'none';
        }
      });
      mobileMenuBtn.addEventListener('click', function() {
        sidebar.classList.add('active');
        overlaySidebar.classList.add('active');
      });
      overlaySidebar.addEventListener('click', function() {
        sidebar.classList.remove('active');
        overlaySidebar.classList.remove('active');
      });
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });
      // 加载默认语音设置
      let defaultVoice = localStorage.getItem(defaultVoiceKey) || defaultVoiceSelect.options[0].value;
      defaultVoiceSelect.value = defaultVoice;
      // 会话相关操作
      function saveConversations() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(conversations));
      }
      function loadConversations() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          conversations = JSON.parse(saved);
          if (conversations.length > 0) {
            currentConversationId = conversations[conversations.length - 1].id;
            loadConversation(currentConversationId);
          }
        }
        updateSidebar();
      }
      function updateSidebar() {
        sidebarContent.innerHTML = '';
        conversations.forEach(conv => {
          const item = document.createElement('div');
          item.className = 'chat-history-item';
          if (conv.id === currentConversationId) {
            item.classList.add('active');
          }
          item.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            ${conv.title}
          `;
          item.addEventListener('click', function() {
            currentConversationId = conv.id;
            updateSidebar();
            loadConversation(conv.id);
          });
          sidebarContent.appendChild(item);
        });
      }
      function loadConversation(convId) {
        const conv = conversations.find(c => c.id === convId);
        chatArea.innerHTML = '';
        const now = new Date();
        const hrs = now.getHours().toString().padStart(2, '0');
        const mins = now.getMinutes().toString().padStart(2, '0');
        const timestampDiv = document.createElement('div');
        timestampDiv.className = 'timestamp';
        timestampDiv.innerHTML = `今天 <span id="currentTime">${hrs}:${mins}</span>`;
        chatArea.appendChild(timestampDiv);
        if (conv && conv.messages) {
          conv.messages.forEach(entry => {
            if (entry.role === 'user') {
              appendUserMessage(entry.content, entry.id, false);
            } else if (entry.role === 'assistant') {
              if (entry.audioUrl) {
                const audio = new Audio(entry.audioUrl);
                const formattedDuration = formatTime(entry.duration);
                appendBotMessage(audio, formattedDuration, "", entry.id, false, entry.voice, entry.transcript);
              }
            } else if (entry.role === 'error') {
              appendErrorMessage(entry.content.split('正忙')[0], entry.id, false);
            }
          });
        }
        scrollToBottom();
      }
      function createNewConversation() {
        const newConv = {
          id: 'conv_' + Date.now(),
          title: '新对话',
          messages: []
        };
        conversations.push(newConv);
        currentConversationId = newConv.id;
        defaultVoiceSelect.value = defaultVoice;
        updateSidebar();
        chatArea.innerHTML = '';
        const now = new Date();
        const hrs = now.getHours().toString().padStart(2, '0');
        const mins = now.getMinutes().toString().padStart(2, '0');
        const timestampDiv = document.createElement('div');
        timestampDiv.className = 'timestamp';
        timestampDiv.innerHTML = `今天 <span id="currentTime">${hrs}:${mins}</span>`;
        chatArea.appendChild(timestampDiv);
        saveConversations();
      }
      newChatBtn.addEventListener('click', function() {
        createNewConversation();
      });
      if (!localStorage.getItem(STORAGE_KEY)) {
        createNewConversation();
      } else {
        loadConversations();
      }
      deleteAllBtn.addEventListener('click', function() {
        if (confirm('确定要删除所有对话吗？')) {
          conversations = [];
          currentConversationId = null;
          localStorage.removeItem(STORAGE_KEY);
          updateSidebar();
          chatArea.innerHTML = '';
        }
      });
      function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        messageInput.value = '';
        messageInput.style.height = 'auto';
        appendUserMessage(message);
        let conv = conversations.find(c => c.id === currentConversationId);
        const messageId = 'msg_' + Date.now();
        conv.messages.push({
          id: messageId,
          role: 'user',
          content: message,
          timestamp: new Date().toISOString()
        });
        if (conv.title === '新对话' && message.length > 0) {
          conv.title = message.slice(0, 10) + '...';
          updateSidebar();
        }
        saveConversations();
        scrollToBottom();
        sendBtn.innerHTML = '<div class="loading"></div>';
        sendBtn.disabled = true;
        const selectedVoice = defaultVoice;
        const contextCount = parseInt(modalContextSelect.value);
        let fullMessage = message;
        if (contextCount > 0) {
          const msgs = conv.messages;
          let relevant = msgs.slice(-Math.min(contextCount * 2 + 1, msgs.length));
          if (relevant.length > 1) {
            fullMessage = "以下是对话上下文：\n\n";
            for (let i = 0; i < relevant.length - 1; i++) {
              const entry = relevant[i];
              const role = entry.role === 'user' ? '用户' : '助手';
              fullMessage += `${role}：${entry.content}\n\n`;
            }
            fullMessage += "当前问题：\n" + message;
            appendContextInfo(contextCount);
          }
        }
        const apiUrl = `https://text.pollinations.ai/${encodeURIComponent(fullMessage)}?model=openai-audio&voice=${selectedVoice}`;
        const audio = new Audio(apiUrl);
        // 在 oncanplaythrough 回调中添加标记，防止重复生成语音消息
        audio.oncanplaythrough = function() {
          if (audio._appended) return;
          audio._appended = true;
          sendBtn.innerHTML = `<svg class="send-icon" viewBox="0 0 24 24" fill="none">
            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>`;
          sendBtn.disabled = false;
          const duration = audio.duration;
          const formattedDuration = formatTime(duration);
          const botMessageId = 'bot_' + Date.now();
          appendBotMessage(audio, formattedDuration, "", botMessageId, false, selectedVoice);
          conv.messages.push({
            id: botMessageId,
            role: 'assistant',
            content: "",
            audioUrl: apiUrl,
            duration: duration,
            voice: selectedVoice,
            timestamp: new Date().toISOString()
          });
          saveConversations();
          scrollToBottom();
        };
        audio.onerror = function() {
          sendBtn.innerHTML = `<svg class="send-icon" viewBox="0 0 24 24" fill="none">
            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>`;
          sendBtn.disabled = false;
          const errorMessageId = 'error_' + Date.now();
          appendErrorMessage(selectedVoice, errorMessageId);
          conv.messages.push({
            id: errorMessageId,
            role: 'error',
            content: `${selectedVoice}正忙，请稍后提问或选择其他聊天助手`,
            timestamp: new Date().toISOString()
          });
          saveConversations();
          scrollToBottom();
        };
      }
      function appendUserMessage(text, messageId = null, appendToConv = true) {
        const messageGroup = document.createElement('div');
        messageGroup.className = 'message-group';
        const messageRow = document.createElement('div');
        messageRow.className = 'message-row user-message';
        if (messageId) {
          messageRow.setAttribute('data-message-id', messageId);
        }
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container';
        const avatar = document.createElement('div');
        avatar.className = 'avatar user-avatar';
        avatar.style.backgroundImage = `url(${localStorage.getItem('userAvatar') || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + Math.random()})`;
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content user-content';
        messageContent.textContent = text;
        messageContainer.appendChild(avatar);
        messageContainer.appendChild(messageContent);
        messageRow.appendChild(messageContainer);
        messageGroup.appendChild(messageRow);
        chatArea.appendChild(messageGroup);
      }
      function appendContextInfo(contextCount) {
        const contextInfo = document.createElement('div');
        contextInfo.className = 'context-info';
        const infoIcon = document.createElement('div');
        infoIcon.innerHTML = `
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 16V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>`;
        const infoText = document.createElement('span');
        infoText.textContent = `正在读取前${contextCount}条上下文消息...`;
        contextInfo.appendChild(infoIcon);
        contextInfo.appendChild(infoText);
        chatArea.appendChild(contextInfo);
      }
      
      // 修改后的 appendBotMessage 函数：添加语音转文本按钮和显示转录文本
            function appendBotMessage(audio, duration, text, messageId = null, appendToConv = true, voiceName = 'AI', transcript = null) {
        if(messageId && document.querySelector(`[data-message-id="${messageId}"]`)) {
          return;
        }
        if (messageId) {
          audio.dataAudioId = messageId;
        }
        const messageGroup = document.createElement('div');
        messageGroup.className = 'message-group';
        const messageRow = document.createElement('div');
        messageRow.className = 'message-row bot-message';
        if (messageId) {
          messageRow.setAttribute('data-message-id', messageId);
        }
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container';
        const avatarContainer = document.createElement('div');
        avatarContainer.className = 'avatar-container';
        const avatar = document.createElement('div');
        avatar.className = 'avatar bot-avatar';
        avatar.textContent = 'AI';
        const assistantLabel = document.createElement('div');
        assistantLabel.className = 'assistant-name';
        assistantLabel.textContent = voiceName;
        avatarContainer.appendChild(avatar);
        avatarContainer.appendChild(assistantLabel);
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content bot-content';
        if (text && text.trim().length > 0) {
          const textContent = document.createElement('div');
          textContent.textContent = text;
          textContent.style.marginBottom = '15px';
          messageContent.appendChild(textContent);
        }
        const audioContainer = document.createElement('div');
        audioContainer.className = 'audio-container';
        const playButton = document.createElement('div');
        playButton.className = 'play-button';
        playButton.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M8 5V19L19 12L8 5Z" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>`;
        playButton.addEventListener('click', function(e) {
          e.stopPropagation();
          playAudio(audio, voiceWave, playButton);
        });
        const voiceWave = document.createElement('div');
        voiceWave.className = 'voice-wave paused';
        voiceWave.setAttribute('data-audio-id', messageId || Date.now().toString());
        const waveAnimation = document.createElement('div');
        waveAnimation.className = 'wave-animation';
        for (let i = 0; i < 10; i++) {
          const bar = document.createElement('div');
          bar.className = 'bar';
          waveAnimation.appendChild(bar);
        }
        voiceWave.appendChild(waveAnimation);
        const durationSpan = document.createElement('span');
        durationSpan.className = 'voice-duration';
        durationSpan.textContent = duration;
        const downloadButton = document.createElement('button');
        downloadButton.className = 'download-btn';
        downloadButton.textContent = '下载';
        downloadButton.addEventListener('click', function(e) {
          e.stopPropagation();
          const a = document.createElement('a');
          a.href = audio.src;
          a.download = 'audio_' + Date.now() + '.mp3';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        });
        
        // 新增：语音转文本按钮
        const transcribeButton = document.createElement('button');
        transcribeButton.className = 'transcribe-btn';
        transcribeButton.textContent = '转文本';
        transcribeButton.addEventListener('click', function(e) {
          e.stopPropagation();
          
          // 检查是否已经有转录文本
          const existingTranscript = messageRow.querySelector('.transcript-container');
          if (existingTranscript && !existingTranscript.classList.contains('transcript-loading')) {
            return; // 如果已经有转录结果，不再重复请求
          }
          
          // 创建或获取转录容器
          let transcriptContainer;
          if (existingTranscript) {
            transcriptContainer = existingTranscript;
            transcriptContainer.innerHTML = ''; // 清空内容以显示新的加载状态
          } else {
            transcriptContainer = document.createElement('div');
            transcriptContainer.className = 'transcript-container transcript-loading';
            messageContent.appendChild(transcriptContainer);
          }
          
          // 显示加载状态
          const loadingSpinner = document.createElement('div');
          loadingSpinner.className = 'spinner';
          const loadingText = document.createElement('span');
          loadingText.textContent = '正在转录语音...';
          transcriptContainer.appendChild(loadingSpinner);
          transcriptContainer.appendChild(loadingText);
          
          // 执行语音转文本
          transcribeAudio(audio.src, messageId).then(text => {
            // 更新UI显示转录结果
            transcriptContainer.innerHTML = text;
            transcriptContainer.classList.remove('transcript-loading');
            
            // 保存转录结果到会话
            const conv = conversations.find(c => c.id === currentConversationId);
            if (conv) {
              const message = conv.messages.find(m => m.id === messageId);
              if (message) {
                message.transcript = text;
                saveConversations();
              }
            }
          }).catch(error => {
            console.error('转录失败:', error);
            transcriptContainer.innerHTML = '转录失败，请检查API设置或稍后重试。';
            transcriptContainer.classList.remove('transcript-loading');
          });
        });
        
        audioContainer.appendChild(playButton);
        audioContainer.appendChild(voiceWave);
        audioContainer.appendChild(durationSpan);
        audioContainer.appendChild(downloadButton);
        audioContainer.appendChild(transcribeButton); // 添加转录按钮
        messageContent.appendChild(audioContainer);
        
        // 如果已有转录文本，显示出来
        if (transcript) {
          const transcriptContainer = document.createElement('div');
          transcriptContainer.className = 'transcript-container';
          transcriptContainer.textContent = transcript;
          messageContent.appendChild(transcriptContainer);
        }
        
        messageContainer.appendChild(avatarContainer);
        messageContainer.appendChild(messageContent);
        messageRow.appendChild(messageContainer);
        messageGroup.appendChild(messageRow);
        chatArea.appendChild(messageGroup);
      }
      
      // 新增：语音转文本功能
      async function transcribeAudio(audioUrl, messageId) {
        // 获取当前设置
        const settings = JSON.parse(localStorage.getItem(sttSettingsKey)) || {
          service: 'openai',
          openaiApiKey: '',
          azureApiKey: '',
          azureRegion: '',
          googleApiKey: '',
          baiduApiKey: '',
          baiduSecretKey: '',
          xfyunAppId: '',
          xfyunApiKey: '',
          xfyunApiSecret: '',
          ibmApiKey: '',
          ibmServiceUrl: '',
          assemblyApiKey: '',
          customApiUrl: '',
          customApiKey: ''
        };
        
        // 从音频URL获取音频数据
        const response = await fetch(audioUrl);
        const audioBlob = await response.blob();
        
        // 根据设置选择不同的API
        switch(settings.service) {
          case 'openai':
            // OpenAI实现保持不变
            if (!settings.openaiApiKey) {
              throw new Error('请先在设置中填写OpenAI API Key');
            }
            
            // 创建FormData对象
            const formData = new FormData();
            formData.append('file', audioBlob, 'audio.mp3');
            formData.append('model', 'whisper-1');
            
            // 调用OpenAI API
            const transcribeResponse = await fetch('https://api.openai.com/v1/audio/transcriptions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${settings.openaiApiKey}`
              },
              body: formData
            });
            
            if (!transcribeResponse.ok) {
              const errorData = await transcribeResponse.json();
              throw new Error(`API错误: ${errorData.error?.message || transcribeResponse.statusText}`);
            }
            
            const data = await transcribeResponse.json();
            return data.text;
            
          case 'baidu':
            // 百度语音识别实现
            if (!settings.baiduApiKey || !settings.baiduSecretKey) {
              throw new Error('请先在设置中填写百度API Key和Secret Key');
            }
            
            // 获取百度token
            const tokenUrl = `https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${settings.baiduApiKey}&client_secret=${settings.baiduSecretKey}`;
            const tokenResponse = await fetch(tokenUrl, { method: 'POST' });
            
            if (!tokenResponse.ok) {
              throw new Error(`百度API错误: ${tokenResponse.statusText}`);
            }
            
            const tokenData = await tokenResponse.json();
            const accessToken = tokenData.access_token;
            
            // 将音频转为base64
            const reader = new FileReader();
            const audioBase64Promise = new Promise((resolve, reject) => {
              reader.onloadend = () => {
                const base64Audio = reader.result.split(',')[1];
                resolve(base64Audio);
              };
              reader.onerror = reject;
              reader.readAsDataURL(audioBlob);
            });
            
            const base64Audio = await audioBase64Promise;
            
            // 调用百度语音识别API
            const baiduResponse = await fetch(`https://vop.baidu.com/server_api`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                format: 'mp3',
                rate: 16000,
                channel: 1,
                cuid: 'aivoicechat',
                token: accessToken,
                speech: base64Audio,
                len: audioBlob.size
              })
            });
            
            if (!baiduResponse.ok) {
              throw new Error(`百度API错误: ${baiduResponse.statusText}`);
            }
            
            const baiduData = await baiduResponse.json();
            if (baiduData.err_no !== 0) {
              throw new Error(`百度API错误: ${baiduData.err_msg}`);
            }
            
            return baiduData.result[0];
            
          case 'xfyun':
            // 讯飞语音识别实现
            if (!settings.xfyunAppId || !settings.xfyunApiKey || !settings.xfyunApiSecret) {
              throw new Error('请先在设置中填写讯飞APPID、API Key和API Secret');
            }
            
            // 将音频转为base64
            const xfReader = new FileReader();
            const xfAudioBase64Promise = new Promise((resolve, reject) => {
              xfReader.onloadend = () => {
                const base64Audio = xfReader.result.split(',')[1];
                resolve(base64Audio);
              };
              xfReader.onerror = reject;
              xfReader.readAsDataURL(audioBlob);
            });
            
            const xfBase64Audio = await xfAudioBase64Promise;
            
            // 计算讯飞API所需的签名
            const apiKey = settings.xfyunApiKey;
            const apiSecret = settings.xfyunApiSecret;
            const currentTime = Math.floor(Date.now() / 1000);
            const expireTime = currentTime + 60; // 60秒过期
            
            // 原始字符串
            const signOrigin = `host: iat-api.xfyun.cn
request-line: POST /v2/iat HTTP/1.1
date: ${currentTime}
expire: ${expireTime}`;
            
            // 使用CryptoJS计算HMAC-SHA256签名
            const signatureOrigin = CryptoJS.HmacSHA256(signOrigin, apiSecret);
            const signature = CryptoJS.enc.Base64.stringify(signatureOrigin);
            
            // 构建鉴权URL
            const authUrl = `https://iat-api.xfyun.cn/v2/iat?authorization=${encodeURIComponent(signature)}&date=${currentTime}&host=iat-api.xfyun.cn&expire=${expireTime}`;
            
            // 构建请求体
            const xfyunRequestBody = {
              common: {
                app_id: settings.xfyunAppId
              },
              business: {
                language: "zh_cn",
                domain: "iat",
                accent: "mandarin",
                vad_eos: 10000
              },
              data: {
                status: 2, // 2表示最后一帧音频
                format: "audio/mp3",
                encoding: "raw",
                audio: xfBase64Audio
              }
            };
            
            // 调用讯飞语音识别API
            const xfyunResponse = await fetch(authUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json,version=1.0'
              },
              body: JSON.stringify(xfyunRequestBody)
            });
            
            if (!xfyunResponse.ok) {
              throw new Error(`讯飞API错误: ${xfyunResponse.statusText}`);
            }
            
            const xfyunData = await xfyunResponse.json();
            if (xfyunData.code !== 0) {
              throw new Error(`讯飞API错误: ${xfyunData.message}`);
            }
            
            // 解析讯飞返回的结果
            let xfyunResult = '';
            if (xfyunData.data && xfyunData.data.result) {
              xfyunData.data.result.ws.forEach(ws => {
                ws.cw.forEach(cw => {
                  xfyunResult += cw.w;
                });
              });
            }
            
            return xfyunResult;
            
          case 'azure':
            if (!settings.azureApiKey || !settings.azureRegion) {
              throw new Error('请先在设置中填写Azure API Key和区域');
            }
            
            // Azure Speech-to-Text REST API
            const azureUrl = `https://${settings.azureRegion}.stt.speech.microsoft.com/speech/recognition/conversation/cognitiveservices/v1`;
            
            const azureResponse = await fetch(azureUrl, {
              method: 'POST',
              headers: {
                'Ocp-Apim-Subscription-Key': settings.azureApiKey,
                'Content-Type': 'audio/mp3'
              },
              body: audioBlob
            });
            
            if (!azureResponse.ok) {
              throw new Error(`Azure API错误: ${azureResponse.statusText}`);
            }
            
            const azureData = await azureResponse.json();
            return azureData.DisplayText || azureData.NBest[0].Display;
            
          case 'google':
            if (!settings.googleApiKey) {
              throw new Error('请先在设置中填写Google API Key');
            }
            
            // 将音频转为base64
            const googleReader = new FileReader();
            const googleAudioBase64Promise = new Promise((resolve, reject) => {
              googleReader.onloadend = () => {
                const base64Audio = googleReader.result.split(',')[1];
                resolve(base64Audio);
              };
              googleReader.onerror = reject;
              googleReader.readAsDataURL(audioBlob);
            });
            
            const googleBase64Audio = await googleAudioBase64Promise;
            
            // 调用Google Speech-to-Text API
            const googleResponse = await fetch(`https://speech.googleapis.com/v1/speech:recognize?key=${settings.googleApiKey}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                config: {
                  encoding: 'MP3',
                  sampleRateHertz: 16000,
                  languageCode: 'zh-CN'
                },
                audio: {
                  content: googleBase64Audio
                }
              })
            });
            
            if (!googleResponse.ok) {
              throw new Error(`Google API错误: ${googleResponse.statusText}`);
            }
            
            const googleData = await googleResponse.json();
            return googleData.results[0].alternatives[0].transcript;
            
          case 'ibm':
            if (!settings.ibmApiKey || !settings.ibmServiceUrl) {
              throw new Error('请先在设置中填写IBM API Key和服务URL');
            }
            
            // 调用IBM Watson Speech-to-Text API
            const ibmResponse = await fetch(`${settings.ibmServiceUrl}/v1/recognize`, {
              method: 'POST',
              headers: {
                'Authorization': `Basic ${btoa('apikey:' + settings.ibmApiKey)}`,
                'Content-Type': 'audio/mp3'
              },
              body: audioBlob
            });
            
            if (!ibmResponse.ok) {
              throw new Error(`IBM API错误: ${ibmResponse.statusText}`);
            }
            
            const ibmData = await ibmResponse.json();
            return ibmData.results[0].alternatives[0].transcript;
            
          case 'assembly':
            if (!settings.assemblyApiKey) {
              throw new Error('请先在设置中填写AssemblyAI API Key');
            }
            
            // 首先上传音频文件到AssemblyAI
            const uploadResponse = await fetch('https://api.assemblyai.com/v2/upload', {
              method: 'POST',
              headers: {
                'Authorization': settings.assemblyApiKey,
                'Content-Type': 'audio/mp3'
              },
              body: audioBlob
            });
            
            if (!uploadResponse.ok) {
              throw new Error(`AssemblyAI上传错误: ${uploadResponse.statusText}`);
            }
            
            const uploadData = await uploadResponse.json();
            const audioUrl = uploadData.upload_url;
            
            // 创建转录任务
            const transcriptResponse = await fetch('https://api.assemblyai.com/v2/transcript', {
              method: 'POST',
              headers: {
                'Authorization': settings.assemblyApiKey,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                audio_url: audioUrl,
                language_code: 'zh'
              })
            });
            
            if (!transcriptResponse.ok) {
              throw new Error(`AssemblyAI转录错误: ${transcriptResponse.statusText}`);
            }
            
            const transcriptData = await transcriptResponse.json();
            const transcriptId = transcriptData.id;
            
            // 轮询获取转录结果
            let result;
            let status = 'processing';
            
            while (status !== 'completed' && status !== 'error') {
              await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒
              
              const resultResponse = await fetch(`https://api.assemblyai.com/v2/transcript/${transcriptId}`, {
                headers: {
                  'Authorization': settings.assemblyApiKey
                }
              });
              
              if (!resultResponse.ok) {
                throw new Error(`AssemblyAI获取结果错误: ${resultResponse.statusText}`);
              }
              
              result = await resultResponse.json();
              status = result.status;
              
              if (status === 'error') {
                throw new Error(`AssemblyAI转录失败: ${result.error}`);
              }
            }
            
            return result.text;
            
          case 'custom':
            if (!settings.customApiUrl || !settings.customApiKey) {
              throw new Error('请先在设置中填写自定义API信息');
            }
            
            // 创建FormData对象
            const customFormData = new FormData();
            customFormData.append('file', audioBlob, 'audio.mp3');
            
            // 调用自定义API
            const customResponse = await fetch(settings.customApiUrl, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${settings.customApiKey}`
              },
              body: customFormData
            });
            
            if (!customResponse.ok) {
              throw new Error(`API错误: ${customResponse.statusText}`);
            }
            
            const customData = await customResponse.json();
            return customData.text || customData.transcript || JSON.stringify(customData);
            
          default:
            throw new Error('未知的语音转文本服务');
        }
      }
      
      function appendErrorMessage(voiceName, messageId = null, appendToConv = true) {
        const messageGroup = document.createElement('div');
        messageGroup.className = 'message-group';
        const messageRow = document.createElement('div');
        messageRow.className = 'message-row bot-message';
        if (messageId) { messageRow.setAttribute('data-message-id', messageId); }
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container';
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.style.backgroundColor = '#ff4d4f';
        avatar.textContent = '!';
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content bot-content';
        const errorContent = document.createElement('div');
        errorContent.className = 'error-message';
        errorContent.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 8V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>${voiceName}正忙，请稍后提问或选择其他聊天助手</span>`;
        messageContent.appendChild(errorContent);
        messageContainer.appendChild(avatar);
        messageContainer.appendChild(messageContent);
        messageRow.appendChild(messageContainer);
        messageGroup.appendChild(messageRow);
        chatArea.appendChild(messageGroup);
      }
      function playAudio(audio, waveElement, playButton) {
        if (window.currentlyPlaying && window.currentlyPlaying !== audio) {
          window.currentlyPlaying.pause();
          window.currentlyPlaying.currentTime = 0;
          document.querySelectorAll('.voice-wave').forEach(wave => {
            if (wave !== waveElement) {
              wave.classList.remove('playing');
              wave.classList.add('paused');
            }
          });
          document.querySelectorAll('.play-button').forEach(btn => {
            if (btn !== playButton) {
              btn.innerHTML = `
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M8 5V19L19 12L8 5Z" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>`;
            }
          });
        }
        if (audio.paused) {
          audio.play();
          waveElement.classList.remove('paused');
          waveElement.classList.add('playing');
          playButton.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M10 4H6V20H10V4Z" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M18 4H14V20H18V4Z" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
          window.currentlyPlaying = audio;
          audio.onended = function() {
            waveElement.classList.remove('playing');
            waveElement.classList.add('paused');
            playButton.innerHTML = `
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M8 5V19L19 12L8 5Z" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>`;
            window.currentlyPlaying = null;
          };
        } else {
          audio.pause();
          waveElement.classList.remove('playing');
          waveElement.classList.add('paused');
          playButton.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M8 5V19L19 12L8 5Z" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
          window.currentlyPlaying = null;
        }
      }
      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${mins}:${secs}`;
      }
      function scrollToBottom() {
        chatArea.scrollTop = chatArea.scrollHeight;
      }
      function exportChatRecords() {
        const conv = conversations.find(c => c.id === currentConversationId);
        if (!conv || conv.messages.length === 0) {
          alert('当前会话没有聊天记录可导出');
          return;
        }
        let content = `
          <!DOCTYPE html>
          <html>
          <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>聊天记录</title>
          <style>
          body { font-family: "Inter", "Söhne", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; background: #f0f4f8; color: #1a1f36; }
          .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
          .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #e2e8f0; }
          .header h1 { background: linear-gradient(135deg, #3a7bd5, #00d2ff); -webkit-background-clip: text; background-clip: text; color: transparent; margin: 0; font-size: 28px; }
          .header p { color: #718096; margin: 10px 0 0; font-size: 14px; }
          .message-row { padding: 20px; margin-bottom: 15px; border-radius: 12px; }
          .user-message { background-color: rgba(58, 123, 213, 0.05); }
          .bot-message { background-color: rgba(255, 255, 255, 0.8); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
          .message-container { display: flex; gap: 16px; max-width: 100%; }
          .avatar { width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; flex-shrink: 0; box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
          .user-avatar { background: linear-gradient(135deg, #3a7bd5, #00d2ff); }
          .bot-avatar { background: linear-gradient(135deg, #3a7bd5, #00d2ff); }
          .message-content { flex: 1; font-size: 16px; line-height: 1.6; overflow-wrap: break-word; }
          .timestamp { font-size: 12px; color: #718096; margin-top: 8px; text-align: right; }
          audio { width: 100%; margin-top: 15px; border-radius: 10px; }
          .error-message { color: #e53e3e; padding: 10px 14px; background-color: rgba(229,62,62,0.1); border-radius: 10px; margin-top: 8px; }
          .transcript { margin-top: 15px; padding: 12px; background-color: rgba(0,0,0,0.03); border-radius: 8px; font-style: italic; }
          @media (max-width: 768px) { .container { padding: 20px; } .message-content { font-size: 15px; } }
          </style>
          </head>
          <body>
          <div class="container">
          <div class="header">
          <h1>聊天记录</h1>
                                        <p>导出时间：${new Date().toLocaleString()}</p>
          </div>
          `;
        conv.messages.forEach(entry => {
          const timestamp = new Date(entry.timestamp).toLocaleString();
          if (entry.role === 'user') {
            content += `
              <div class="message-row user-message">
              <div class="message-container">
              <div class="avatar user-avatar">用户</div>
              <div class="message-content">
              <div>${entry.content}</div>
              <div class="timestamp">${timestamp}</div>
              </div>
              </div>
              </div>
            `;
          } else if (entry.role === 'assistant') {
            content += `
              <div class="message-row bot-message">
              <div class="message-container">
              <div class="avatar bot-avatar">AI</div>
              <div class="message-content">
              ${entry.transcript ? `<div class="transcript">${entry.transcript}</div>` : ''}
              ${entry.audioUrl ? `<audio controls src="${entry.audioUrl}"></audio>` : ''}
              <div class="timestamp">${timestamp}</div>
              </div>
              </div>
              </div>
            `;
          } else if (entry.role === 'error') {
            content += `
              <div class="message-row bot-message">
              <div class="message-container">
              <div class="avatar" style="background-color: #e53e3e;">!</div>
              <div class="message-content">
              <div class="error-message">${entry.content}</div>
              <div class="timestamp">${timestamp}</div>
              </div>
              </div>
              </div>
            `;
          }
        });
        content += `
          </div>
          </body>
          </html>
        `;
        downloadFile(`聊天记录_${new Date().toISOString().slice(0,10)}.html`, content, 'text/html');
        closeExportModal.click();
      }
      function downloadFile(filename, content, type) {
        const blob = new Blob([content], { type: type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
      function clearChatRecords() {
        const conv = conversations.find(c => c.id === currentConversationId);
        if (conv) { conv.messages = []; }
        chatArea.innerHTML = '';
        const now = new Date();
        const hrs = now.getHours().toString().padStart(2, '0');
        const mins = now.getMinutes().toString().padStart(2, '0');
        const timestampDiv = document.createElement('div');
        timestampDiv.className = 'timestamp';
        timestampDiv.innerHTML = `今天 <span id="currentTime">${hrs}:${mins}</span>`;
        chatArea.appendChild(timestampDiv);
        saveConversations();
        closeClearModal.click();
      }
      document.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      sendBtn.addEventListener('click', sendMessage);
      menuButton.addEventListener('click', function() {
        dropdownMenu.classList.toggle('active');
      });
      document.addEventListener('click', function(e) {
        if (!menuButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
          dropdownMenu.classList.remove('active');
        }
      });
      exportChat.addEventListener('click', function() {
        dropdownMenu.classList.remove('active');
        exportModal.style.display = 'flex';
      });
      clearChat.addEventListener('click', function() {
        dropdownMenu.classList.remove('active');
        clearModal.style.display = 'flex';
      });
      settingsItem.addEventListener('click', function() {
        dropdownMenu.classList.remove('active');
        settingsModal.style.display = 'flex';
      });
      closeExportModal.addEventListener('click', function() { exportModal.style.display = 'none'; });
      cancelExport.addEventListener('click', function() { exportModal.style.display = 'none'; });
      confirmExport.addEventListener('click', exportChatRecords);
      closeClearModal.addEventListener('click', function() { clearModal.style.display = 'none'; });
      cancelClear.addEventListener('click', function() { clearModal.style.display = 'none'; });
      confirmClear.addEventListener('click', clearChatRecords);
      closeSettingsModal.addEventListener('click', function() { settingsModal.style.display = 'none'; });
      
      // 修改保存设置函数，增加语音转文本设置的保存
      saveSettings.addEventListener('click', function() {
        // 保存默认语音设置
        defaultVoice = defaultVoiceSelect.value;
        localStorage.setItem(defaultVoiceKey, defaultVoice);
        
        // 保存语音转文本设置
        const sttSettings = {
          service: sttApiSelect.value,
          openaiApiKey: openaiApiKey.value,
          azureApiKey: azureApiKey.value,
          azureRegion: azureRegion.value,
          googleApiKey: googleApiKey.value,
          baiduApiKey: baiduApiKey.value,
          baiduSecretKey: baiduSecretKey.value,
          xfyunAppId: xfyunAppId.value,
          xfyunApiKey: xfyunApiKey.value,
          xfyunApiSecret: xfyunApiSecret.value,
          ibmApiKey: ibmApiKey.value,
          ibmServiceUrl: ibmServiceUrl.value,
          assemblyApiKey: assemblyApiKey.value,
          customApiUrl: customApiUrl.value,
          customApiKey: customApiKey.value
        };
        localStorage.setItem(sttSettingsKey, JSON.stringify(sttSettings));
        
        settingsModal.style.display = 'none';
      });
      
      exportModal.addEventListener('click', function(e) {
        if (e.target === exportModal) { exportModal.style.display = 'none'; }
      });
      clearModal.addEventListener('click', function(e) {
        if (e.target === clearModal) { clearModal.style.display = 'none'; }
      });
      settingsModal.addEventListener('click', function(e) {
        if (e.target === settingsModal) { settingsModal.style.display = 'none'; }
      });
      userBtn.addEventListener('click', function() {
        announcementModal.style.display = 'flex';
      });
      closeAnnouncementModal.addEventListener('click', function() {
        announcementModal.style.display = 'none';
      });
      closeAnnouncementConfirm.addEventListener('click', function() {
        announcementModal.style.display = 'none';
      });
      const voiceBtn = document.getElementById('voiceBtn');
      voiceBtn.addEventListener('click', function() {
        voiceModal.style.display = 'flex';
      });
      closeVoiceModal.addEventListener('click', function() { voiceModal.style.display = 'none'; });
      cancelVoiceModal.addEventListener('click', function() { voiceModal.style.display = 'none'; });
      confirmVoiceModal.addEventListener('click', function() {
        defaultVoice = modalVoiceSelect.value;
        localStorage.setItem(defaultVoiceKey, defaultVoice);
        voiceModal.style.display = 'none';
      });
      const contextBtn = document.getElementById('contextBtn');
      contextBtn.addEventListener('click', function() {
        contextModal.style.display = 'flex';
      });
      closeContextModal.addEventListener('click', function() { contextModal.style.display = 'none'; });
      cancelContextModal.addEventListener('click', function() { contextModal.style.display = 'none'; });
      confirmContextModal.addEventListener('click', function() {
        contextModal.style.display = 'none';
      });
    });
  </script>
</body>
</html>
